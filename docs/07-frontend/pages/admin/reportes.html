<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes | Sistema de Consultas M√©dicas</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-grid{display:grid;grid-template-columns:250px 1fr;min-height:100vh;background-color:var(--bg-secondary)}.dashboard-sidebar{background-color:white;box-shadow:var(--shadow-md);padding:var(--space-6);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}.sidebar-brand{display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-8);padding-bottom:var(--space-6);border-bottom:2px solid var(--border-light)}.sidebar-brand-icon{font-size:var(--text-4xl)}.sidebar-brand-text{font-size:var(--text-lg);font-weight:700;color:var(--primary-500)}.sidebar-user{background-color:var(--primary-50);padding:var(--space-4);border-radius:var(--radius-lg);margin-bottom:var(--space-6)}.sidebar-user-name{font-weight:700;color:var(--text-primary);margin-bottom:var(--space-1)}.sidebar-user-role{font-size:var(--text-sm);color:var(--text-secondary)}.sidebar-nav{flex:1}.sidebar-nav-item{list-style:none;margin-bottom:var(--space-2)}.sidebar-nav-link{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-lg);font-weight:500;transition:all var(--transition-fast)}.sidebar-nav-link:hover{background-color:var(--primary-50);color:var(--primary-600)}.sidebar-nav-link.active{background-color:var(--primary-500);color:white}.sidebar-nav-icon{font-size:var(--text-xl)}.sidebar-footer{padding-top:var(--space-6);border-top:2px solid var(--border-light)}.dashboard-main{padding:var(--space-8);overflow-y:auto}.dashboard-header{margin-bottom:var(--space-8)}.dashboard-title{font-size:var(--text-3xl);font-weight:700;color:var(--text-primary);margin-bottom:var(--space-2)}.dashboard-subtitle{font-size:var(--text-lg);color:var(--text-secondary)}.filters-card{background-color:white;border-radius:var(--radius-2xl);padding:var(--space-6);box-shadow:var(--shadow-sm);margin-bottom:var(--space-6)}.filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--space-4);margin-bottom:var(--space-4)}.filter-select{padding:var(--space-3) var(--space-4);border:2px solid var(--border-light);border-radius:var(--radius-lg);font-size:var(--text-base);background-color:white;width:100%}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--space-4);margin-bottom:var(--space-6)}.stat-card{background-color:white;border-radius:var(--radius-xl);padding:var(--space-5);box-shadow:var(--shadow-sm);text-align:center}.stat-number{font-size:var(--text-4xl);font-weight:700;margin-bottom:var(--space-2)}.stat-label{color:var(--text-secondary);font-size:var(--text-sm)}.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:var(--space-6);margin-bottom:var(--space-6)}.chart-card{background-color:white;border-radius:var(--radius-2xl);padding:var(--space-6);box-shadow:var(--shadow-sm)}.chart-title{font-size:var(--text-xl);font-weight:700;color:var(--text-primary);margin-bottom:var(--space-4);padding-bottom:var(--space-3);border-bottom:2px solid var(--border-light)}.chart-container{position:relative;height:300px}@media (max-width:768px){.dashboard-grid{grid-template-columns:1fr}.dashboard-sidebar{display:none}.filters-grid{grid-template-columns:1fr}.charts-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <aside class="dashboard-sidebar">
            <div class="sidebar-brand"><span class="sidebar-brand-icon">üè•</span><span class="sidebar-brand-text">MediConsultas</span></div>
            <div class="sidebar-user"><div class="sidebar-user-name" id="userName">Cargando...</div><div class="sidebar-user-role">Administrador</div></div>
            <nav class="sidebar-nav">
                <ul style="list-style:none;padding:0;margin:0">
                    <li class="sidebar-nav-item"><a href="/pages/admin/dashboard.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üè†</span><span>Dashboard</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/especialidades.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">‚öïÔ∏è</span><span>Especialidades</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/medicos.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üë®‚Äç‚öïÔ∏è</span><span>M√©dicos</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/pacientes.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üë•</span><span>Pacientes</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/consultorios.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üö™</span><span>Consultorios</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/citas.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üìÖ</span><span>Citas</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/admin/reportes.html" class="sidebar-nav-link active"><span class="sidebar-nav-icon">üìä</span><span>Reportes</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><button class="btn btn-danger btn-block" id="logoutBtn"><span>üö™</span><span>Cerrar Sesi√≥n</span></button></div>
        </aside>
        <main class="dashboard-main">
            <div class="dashboard-header animate-fade-in"><h1 class="dashboard-title">Reportes y Estad√≠sticas</h1><p class="dashboard-subtitle">Genere reportes personalizados del sistema</p></div>
            <div class="filters-card animate-slide-up">
                <h3 style="font-weight:700;margin-bottom:var(--space-4)">Filtros de Reporte</h3>
                <div class="filters-grid">
                    <div class="form-group"><label class="form-label">Fecha Inicio</label><input type="date" id="fechaInicio" class="filter-select"></div>
                    <div class="form-group"><label class="form-label">Fecha Fin</label><input type="date" id="fechaFin" class="filter-select"></div>
                    <div class="form-group"><label class="form-label">Especialidad</label><select id="especialidadFilter" class="filter-select"><option value="">Todas</option></select></div>
                    <div class="form-group"><label class="form-label">Estado</label><select id="estadoFilter" class="filter-select"><option value="">Todos</option><option value="PROGRAMADA">Programada</option><option value="CONFIRMADA">Confirmada</option><option value="ATENDIDA">Atendida</option><option value="CANCELADA">Cancelada</option></select></div>
                </div>
                <button class="btn btn-primary" id="generateBtn">üìä Generar Reporte</button>
            </div>
            <div class="stats-grid animate-slide-up" style="animation-delay:0.1s">
                <div class="stat-card"><div class="stat-number" style="color:var(--primary-600)" id="totalCitas">0</div><div class="stat-label">Total Citas</div></div>
                <div class="stat-card"><div class="stat-number" style="color:var(--success-600)" id="citasAtendidas">0</div><div class="stat-label">Atendidas</div></div>
                <div class="stat-card"><div class="stat-number" style="color:var(--warning-600)" id="citasPendientes">0</div><div class="stat-label">Pendientes</div></div>
                <div class="stat-card"><div class="stat-number" style="color:var(--error-600)" id="citasCanceladas">0</div><div class="stat-label">Canceladas</div></div>
            </div>
            <div class="charts-grid animate-slide-up" style="animation-delay:0.2s">
                <div class="chart-card"><h3 class="chart-title">Citas por Especialidad</h3><div class="chart-container"><canvas id="especialidadesChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">Citas por Estado</h3><div class="chart-container"><canvas id="estadosChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">Top 5 M√©dicos (m√°s citas)</h3><div class="chart-container"><canvas id="medicosChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">Tendencia Mensual</h3><div class="chart-container"><canvas id="tendenciaChart"></canvas></div></div>
            </div>
        </main>
    </div>
    <script src="/js/main.js"></script>
    <script src="/js/utils/auth-guard.js"></script>
    <script>
        let citas=[],especialidades=[],charts={};document.addEventListener('DOMContentLoaded',async()=>{const user=getCurrentUser();if(!user||user.rol!=='ADMIN'){window.location.href='/pages/auth/login.html';return}document.getElementById('userName').textContent=user.username;document.getElementById('logoutBtn').addEventListener('click',()=>{logout();window.location.href='/pages/auth/login.html'});const hoy=new Date(),hace30=new Date(hoy.getTime()-30*24*60*60*1000);document.getElementById('fechaInicio').value=hace30.toISOString().split('T')[0];document.getElementById('fechaFin').value=hoy.toISOString().split('T')[0];document.getElementById('generateBtn').addEventListener('click',generateReport);await loadEspecialidades();await generateReport()});async function loadEspecialidades(){const token=getToken();try{const response=await fetch(`${API_BASE_URL}/especialidades`,{headers:{'Authorization':`Bearer ${token}`}});especialidades=await response.json();const filter=document.getElementById('especialidadFilter');filter.innerHTML='<option value="">Todas</option>'+especialidades.map(e=>`<option value="${e.nombre}">${e.nombre}</option>`).join('')}catch(error){console.error('Error:',error)}}async function generateReport(){const token=getToken(),fechaInicio=document.getElementById('fechaInicio').value,fechaFin=document.getElementById('fechaFin').value,especialidad=document.getElementById('especialidadFilter').value,estado=document.getElementById('estadoFilter').value;try{const response=await fetch(`${API_BASE_URL}/citas`,{headers:{'Authorization':`Bearer ${token}`}});let data=await response.json();if(fechaInicio){data=data.filter(c=>c.fechaCita>=fechaInicio)}if(fechaFin){data=data.filter(c=>c.fechaCita<=fechaFin)}if(especialidad){data=data.filter(c=>c.especialidad===especialidad)}if(estado){data=data.filter(c=>c.estado===estado)}citas=data;updateStats();updateCharts()}catch(error){console.error('Error:',error);alert('Error al generar reporte')}}function updateStats(){const total=citas.length,atendidas=citas.filter(c=>c.estado==='ATENDIDA').length,pendientes=citas.filter(c=>c.estado==='PROGRAMADA'||c.estado==='CONFIRMADA').length,canceladas=citas.filter(c=>c.estado==='CANCELADA').length;document.getElementById('totalCitas').textContent=total;document.getElementById('citasAtendidas').textContent=atendidas;document.getElementById('citasPendientes').textContent=pendientes;document.getElementById('citasCanceladas').textContent=canceladas}function updateCharts(){updateEspecialidadesChart();updateEstadosChart();updateMedicosChart();updateTendenciaChart()}function updateEspecialidadesChart(){const ctx=document.getElementById('especialidadesChart').getContext('2d');if(charts.especialidades)charts.especialidades.destroy();const counts={};citas.forEach(c=>{const esp=c.especialidad||'Sin especialidad';counts[esp]=(counts[esp]||0)+1});const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,6);charts.especialidades=new Chart(ctx,{type:'doughnut',data:{labels:sorted.map(e=>e[0]),datasets:[{data:sorted.map(e=>e[1]),backgroundColor:['#0066CC','#00B8A9','#F8B739','#F97316','#8B5CF6','#EC4899']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}})}function updateEstadosChart(){const ctx=document.getElementById('estadosChart').getContext('2d');if(charts.estados)charts.estados.destroy();const counts={PROGRAMADA:0,CONFIRMADA:0,ATENDIDA:0,CANCELADA:0,NO_PRESENTADO:0};citas.forEach(c=>counts[c.estado]=(counts[c.estado]||0)+1);charts.estados=new Chart(ctx,{type:'bar',data:{labels:['Programada','Confirmada','Atendida','Cancelada','No Presentado'],datasets:[{label:'Citas',data:[counts.PROGRAMADA,counts.CONFIRMADA,counts.ATENDIDA,counts.CANCELADA,counts.NO_PRESENTADO],backgroundColor:['#F8B739','#0066CC','#00C48C','#FF6B6B','#95A5A6']}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}})}function updateMedicosChart(){const ctx=document.getElementById('medicosChart').getContext('2d');if(charts.medicos)charts.medicos.destroy();const counts={};citas.forEach(c=>{const med=c.nombreMedico||'Sin asignar';counts[med]=(counts[med]||0)+1});const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);charts.medicos=new Chart(ctx,{type:'bar',data:{labels:sorted.map(m=>m[0]),datasets:[{label:'Citas',data:sorted.map(m=>m[1]),backgroundColor:'#0066CC'}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{beginAtZero:true}},plugins:{legend:{display:false}}}})}function updateTendenciaChart(){const ctx=document.getElementById('tendenciaChart').getContext('2d');if(charts.tendencia)charts.tendencia.destroy();const monthCounts={};citas.forEach(c=>{const mes=c.fechaCita.substring(0,7);monthCounts[mes]=(monthCounts[mes]||0)+1});const sorted=Object.entries(monthCounts).sort((a,b)=>a[0].localeCompare(b[0]));charts.tendencia=new Chart(ctx,{type:'line',data:{labels:sorted.map(m=>{const[year,month]=m[0].split('-');return new Date(year,month-1).toLocaleDateString('es-PE',{month:'short',year:'numeric'})}),datasets:[{label:'Citas',data:sorted.map(m=>m[1]),borderColor:'#0066CC',backgroundColor:'rgba(0,102,204,0.1)',tension:0.4,fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}})}
    </script>
</body>
</html>
