<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Citas | Sistema de Consultas M√©dicas</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <style>
        .dashboard-grid{display:grid;grid-template-columns:250px 1fr;min-height:100vh;background-color:var(--bg-secondary)}.dashboard-sidebar{background-color:white;box-shadow:var(--shadow-md);padding:var(--space-6);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}.sidebar-brand{display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-8);padding-bottom:var(--space-6);border-bottom:2px solid var(--border-light)}.sidebar-brand-icon{font-size:var(--text-4xl)}.sidebar-brand-text{font-size:var(--text-lg);font-weight:700;color:var(--primary-500)}.sidebar-user{background-color:var(--primary-50);padding:var(--space-4);border-radius:var(--radius-lg);margin-bottom:var(--space-6)}.sidebar-user-name{font-weight:700;color:var(--text-primary);margin-bottom:var(--space-1)}.sidebar-user-role{font-size:var(--text-sm);color:var(--text-secondary)}.sidebar-nav{flex:1}.sidebar-nav-item{list-style:none;margin-bottom:var(--space-2)}.sidebar-nav-link{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-lg);font-weight:500;transition:all var(--transition-fast)}.sidebar-nav-link:hover{background-color:var(--primary-50);color:var(--primary-600)}.sidebar-nav-link.active{background-color:var(--primary-500);color:white}.sidebar-nav-icon{font-size:var(--text-xl)}.sidebar-footer{padding-top:var(--space-6);border-top:2px solid var(--border-light)}.dashboard-main{padding:var(--space-8);overflow-y:auto}.dashboard-header{margin-bottom:var(--space-8)}.dashboard-title{font-size:var(--text-3xl);font-weight:700;color:var(--text-primary);margin-bottom:var(--space-2)}.dashboard-subtitle{font-size:var(--text-lg);color:var(--text-secondary)}.tabs{display:flex;gap:var(--space-2);margin-bottom:var(--space-6);background-color:white;padding:var(--space-4);border-radius:var(--radius-xl);box-shadow:var(--shadow-sm)}.tab-button{flex:1;padding:var(--space-3) var(--space-6);border:none;background-color:transparent;color:var(--text-secondary);font-weight:600;border-radius:var(--radius-lg);cursor:pointer;transition:all var(--transition-fast)}.tab-button:hover{background-color:var(--primary-50);color:var(--primary-600)}.tab-button.active{background-color:var(--primary-500);color:white}.citas-container{background-color:white;border-radius:var(--radius-2xl);padding:var(--space-6);box-shadow:var(--shadow-sm)}.cita-card{border:2px solid var(--border-light);border-radius:var(--radius-xl);padding:var(--space-5);margin-bottom:var(--space-4);transition:all var(--transition-fast)}.cita-card:hover{box-shadow:var(--shadow-md);border-color:var(--primary-200)}.cita-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:var(--space-4)}.cita-info h3{font-weight:700;color:var(--text-primary);margin-bottom:var(--space-2)}.cita-detail{display:flex;align-items:center;gap:var(--space-2);color:var(--text-secondary);font-size:var(--text-sm);margin-bottom:var(--space-1)}.cita-status{padding:var(--space-2) var(--space-4);border-radius:var(--radius-lg);font-size:var(--text-sm);font-weight:600}.status-programada{background-color:var(--warning-100);color:var(--warning-700)}.status-confirmada{background-color:var(--info-100);color:var(--info-700)}.status-atendida{background-color:var(--success-100);color:var(--success-700)}.status-cancelada{background-color:var(--error-100);color:var(--error-700)}.cita-actions{display:flex;gap:var(--space-2);margin-top:var(--space-4);padding-top:var(--space-4);border-top:2px solid var(--border-light)}.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}.modal-overlay.active{display:flex}.modal-content{background-color:white;border-radius:var(--radius-2xl);padding:var(--space-6);max-width:500px;width:90%}.modal-header{margin-bottom:var(--space-4)}.modal-title{font-size:var(--text-2xl);font-weight:700;color:var(--text-primary)}.modal-footer{display:flex;gap:var(--space-3);margin-top:var(--space-6)}@media (max-width:768px){.dashboard-grid{grid-template-columns:1fr}.dashboard-sidebar{display:none}}
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <aside class="dashboard-sidebar">
            <div class="sidebar-brand"><span class="sidebar-brand-icon">üè•</span><span class="sidebar-brand-text">MediConsultas</span></div>
            <div class="sidebar-user"><div class="sidebar-user-name" id="userName">Cargando...</div><div class="sidebar-user-role">Paciente</div></div>
            <nav class="sidebar-nav">
                <ul style="list-style:none;padding:0;margin:0">
                    <li class="sidebar-nav-item"><a href="/pages/paciente/dashboard.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üè†</span><span>Inicio</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/paciente/reservar-cita.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üìÖ</span><span>Reservar Cita</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/paciente/mis-citas.html" class="sidebar-nav-link active"><span class="sidebar-nav-icon">üìã</span><span>Mis Citas</span></a></li>
                    <li class="sidebar-nav-item"><a href="/pages/paciente/perfil.html" class="sidebar-nav-link"><span class="sidebar-nav-icon">üë§</span><span>Mi Perfil</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><button class="btn btn-danger btn-block" id="logoutBtn"><span>üö™</span><span>Cerrar Sesi√≥n</span></button></div>
        </aside>
        <main class="dashboard-main">
            <div class="dashboard-header animate-fade-in"><h1 class="dashboard-title">Mis Citas M√©dicas</h1><p class="dashboard-subtitle">Gestione sus citas programadas y revise su historial</p></div>
            <div class="tabs animate-slide-up">
                <button class="tab-button active" data-tab="proximas">Pr√≥ximas Citas</button>
                <button class="tab-button" data-tab="historial">Historial</button>
            </div>
            <div class="citas-container animate-slide-up" style="animation-delay:0.1s">
                <div id="citasContent"><div class="spinner-container"><div class="spinner"></div><p>Cargando citas...</p></div></div>
            </div>
        </main>
    </div>
    <div class="modal-overlay" id="cancelModal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Cancelar Cita</h3></div>
            <div class="modal-body">
                <p style="margin-bottom:var(--space-4)">¬øEst√° seguro que desea cancelar esta cita?</p>
                <div class="form-group"><label for="motivoCancelacion" class="form-label form-label-required">Motivo de Cancelaci√≥n</label>
                <textarea id="motivoCancelacion" class="form-control" rows="3" placeholder="M√≠nimo 10 caracteres" minlength="10" required></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="cancelModalBtn">No, volver</button>
                <button class="btn btn-danger" id="confirmCancelBtn">S√≠, cancelar cita</button>
            </div>
        </div>
    </div>
    <script src="/js/main.js"></script>
    <script src="/js/utils/auth-guard.js"></script>
    <script>
        let currentTab='proximas',selectedCita=null;document.addEventListener('DOMContentLoaded',async()=>{const user=getCurrentUser();if(!user||user.rol!=='PACIENTE'){window.location.href='/pages/auth/login.html';return}document.getElementById('userName').textContent=user.username;document.getElementById('logoutBtn').addEventListener('click',()=>{logout();window.location.href='/pages/auth/login.html'});setupTabs();setupModal();await loadCitas()});function setupTabs(){document.querySelectorAll('.tab-button').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentTab=btn.dataset.tab;loadCitas()})})}function setupModal(){document.getElementById('cancelModalBtn').addEventListener('click',closeModal);document.getElementById('confirmCancelBtn').addEventListener('click',confirmCancelacion)}async function loadCitas(){const user=getCurrentUser(),token=getToken(),container=document.getElementById('citasContent');try{const response=await fetch(`${API_BASE_URL}/citas/paciente/${user.idReferencia}`,{headers:{'Authorization':`Bearer ${token}`}}),citas=await response.json(),now=new Date();let filteredCitas;if(currentTab==='proximas'){filteredCitas=citas.filter(c=>(c.estado==='PROGRAMADA'||c.estado==='CONFIRMADA')&&new Date(c.fechaCita)>=now).sort((a,b)=>new Date(a.fechaCita)-new Date(b.fechaCita))}else{filteredCitas=citas.filter(c=>c.estado==='ATENDIDA'||c.estado==='CANCELADA'||c.estado==='NO_PRESENTADO'||new Date(c.fechaCita)<now).sort((a,b)=>new Date(b.fechaCita)-new Date(a.fechaCita))}renderCitas(filteredCitas)}catch(error){console.error('Error:',error);container.innerHTML='<p style="text-align:center;color:var(--error-600)">Error al cargar las citas</p>'}}function renderCitas(citas){const container=document.getElementById('citasContent');if(citas.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p class="empty-state-text">No hay citas ${currentTab==='proximas'?'programadas':'en el historial'}</p>${currentTab==='proximas'?'<a href="/pages/paciente/reservar-cita.html" class="btn btn-primary">Reservar Nueva Cita</a>':''}</div>`;return}container.innerHTML=citas.map(cita=>{const fecha=new Date(cita.fechaCita),fechaStr=fecha.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),horaStr=cita.horaCita||fecha.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'}),estadoClasses={'PROGRAMADA':'status-programada','CONFIRMADA':'status-confirmada','ATENDIDA':'status-atendida','CANCELADA':'status-cancelada','NO_PRESENTADO':'status-cancelada'},estadoLabels={'PROGRAMADA':'‚è≥ Programada','CONFIRMADA':'‚úì Confirmada','ATENDIDA':'‚úÖ Atendida','CANCELADA':'‚ùå Cancelada','NO_PRESENTADO':'‚ùå No Presentado'},canCancel=(cita.estado==='PROGRAMADA'||cita.estado==='CONFIRMADA')&&new Date(cita.fechaCita).getTime()-new Date().getTime()>(2*60*60*1000);return`<div class="cita-card"><div class="cita-header"><div class="cita-info"><h3>üë®‚Äç‚öïÔ∏è Dr(a). ${cita.nombreMedico||'No asignado'}</h3><div class="cita-detail">üìã ${cita.especialidad||'Consulta General'}</div><div class="cita-detail">üìÖ ${fechaStr}</div><div class="cita-detail">üïê ${horaStr}</div><div class="cita-detail">üè• ${cita.consultorio||'Por asignar'}</div>${cita.motivoConsulta?`<div class="cita-detail" style="margin-top:var(--space-2)">üí¨ ${cita.motivoConsulta}</div>`:''}</div><div class="cita-status ${estadoClasses[cita.estado]}">${estadoLabels[cita.estado]}</div></div>${canCancel?`<div class="cita-actions"><button class="btn btn-danger btn-sm" onclick="openCancelModal(${cita.idCita})">Cancelar Cita</button></div>`:''}${cita.observaciones?`<div style="margin-top:var(--space-3);padding:var(--space-3);background-color:var(--gray-50);border-radius:var(--radius-lg)"><strong>Observaciones:</strong> ${cita.observaciones}</div>`:''}</div>`}).join('')}function openCancelModal(idCita){selectedCita=idCita;document.getElementById('cancelModal').classList.add('active');document.getElementById('motivoCancelacion').value=''}function closeModal(){document.getElementById('cancelModal').classList.remove('active');selectedCita=null}async function confirmCancelacion(){const motivo=document.getElementById('motivoCancelacion').value.trim();if(motivo.length<10){alert('El motivo debe tener al menos 10 caracteres');return}const token=getToken();try{const response=await fetch(`${API_BASE_URL}/citas/${selectedCita}/cancelar`,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({motivoCancelacion:motivo})});if(response.ok){alert('Cita cancelada exitosamente');closeModal();await loadCitas()}else{const error=await response.json();alert(`Error: ${error.message||'No se pudo cancelar la cita'}`)}}catch(error){console.error('Error:',error);alert('Error al conectar con el servidor')}}
    </script>
</body>
</html>
